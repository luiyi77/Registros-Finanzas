<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registros 2025</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <style>
        /* ... (Tu CSS, sin cambios) ... */
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f9;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .form-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            margin: 0 auto 20px;
        }
        .input-group {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        .input-group input {
            width: 50%;
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        select {
            color: #757575;
        }
        select:focus {
            color: #000;
        }
        select option:first-child {
            color: #757575;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        .export-btn {
            background: #007bff;
            margin-top: 10px;
        }
        .export-btn:hover {
            background: #0056b3;
        }
        .sort-btn {
            background: #ff9800;
        }
        .sort-btn:hover {
            background: #e68a00;
        }
        .import-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            cursor: pointer;
        }
        .import-btn:hover {
            background-color: #5a6268;
        }
        .delete-all-btn {
            background-color: #f44336;
        }
        .delete-all-btn:hover {
            background-color: #d32f2f;
        }
        .charts-container-main {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
            max-width: 900px;
            margin-bottom: 20px;
        }
        .chart-container-bar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
        }
        .tables-charts-container-middle {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            width: 100%;
            max-width: 1200px;
        }
        .charts-container-pie {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 20px;
            width: 100%;
            max-width: 350px;
        }
        .chart-container-pie {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
        }
        .tables-container-bottom {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            margin-top: 20px;
            width: 100%;
            max-width: 1200px;
        }
        .table-scroll-container {
            max-height: 500px;
            overflow-y: auto;
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }
        table {
            flex-grow: 1;
            border-collapse: collapse;
            background: white;
            width: 100%;
        }
        #tablaRegistros {
            max-width: 700px;
        }
        #tablaResumen {
            max-width: 500px;
        }
        th, td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #4CAF50;
            color: white;
            position: relative;
            cursor: pointer;
            user-select: none;
        }
        .th-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }
        .total {
            margin-top: 15px;
            font-size: 18px;
            text-align: right;
            font-weight: bold;
            width: 100%;
            max-width: 1200px;
        }
        .delete-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .filter-menu {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 5px;
            z-index: 100;
            display: none;
            width: max-content;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .filter-menu.active {
            display: block;
        }
        .filter-menu label {
            display: block;
            padding: 5px 10px;
            cursor: pointer;
            color: black;
        }
        .filter-menu label:hover {
            background: #f0f0f0;
        }
        .money-cell {
            position: relative;
            overflow: hidden;
            text-align: right;
            background-color: transparent;
            transition: background-size 0.5s ease-in-out;
            background-repeat: no-repeat;
            background-position: left center;
        }
        .money-cell.ingreso {
            background-image: linear-gradient(to right, #d3e9d4, #8bc34a);
        }
        .money-cell.gasto {
            background-image: linear-gradient(to right, #f8d3d3, #f44336);
        }
        .money-cell span {
            position: relative;
            z-index: 2;
            padding: 0 5px;
        }
        #tablaResumen tfoot tr {
            background-color: #f0f0f0;
            font-weight: bold;
            border-top: 2px solid #ccc;
        }
        .total-ingreso {
            background-color: #e8f5e9 !important;
            color: #1b5e20 !important;
        }
        .total-gasto {
            background-color: #fce4ec !important;
            color: #b71c1c !important;
        }
    </style>
</head>
<body>
    <h1>üí∞ Registros 2025</h1>

    <div class="form-container">
        <input type="text" id="descripcion" placeholder="Descripci√≥n">
        <select id="categoria">
            <option value="" disabled selected>Categor√≠a</option>
            <optgroup label="Ingresos">
                <option value="N√≥mina">N√≥mina</option>
                <option value="Extras">Extras</option>
                <option value="Otros ingresos">Otros ingresos</option>
            </optgroup>
            <optgroup label="Inversi√≥n/Desarrollo">
                <option value="Inversi√≥n N√≥mina">Inversi√≥n N√≥mina</option>
                <option value="Gym/Salud">Gym/Salud</option>
                <option value="Educaci√≥n">Educaci√≥n</option>
            </optgroup>
            <optgroup label="Necesidades">
                <option value="Servicios/Renta">Servicios/Renta</option>
                <option value="Comida">Comida</option>
                <option value="Transporte">Transporte</option>
            </optgroup>
            <optgroup label="Gasto personal">
                <option value="Gasto personal">Gasto personal</option>
            </optgroup>
            <optgroup label="Deseos">
                <option value="Streaming">Streaming</option>
                <option value="Salidas/viajes">Salidas/viajes</option>
            </optgroup>
            <optgroup label="Impuestos">
                <option value="Impuestos">Impuestos</option>
            </optgroup>
        </select>
        <div class="input-group">
            <input type="number" id="ingreso-monto" placeholder="Monto Ingreso">
            <input type="number" id="gasto-monto" placeholder="Monto Gasto">
        </div>
        <button onclick="agregarRegistro()">Registrar</button>
        <button class="export-btn" onclick="exportarCSV()">üìÇ Exportar a Excel/CSV</button>
        <label for="import-csv" class="import-btn" style="display: block; text-align: center; margin-top: 10px; padding: 10px; border-radius: 8px; cursor: pointer;">
            üì• Importar CSV
            <input type="file" id="import-csv" accept=".csv" style="display: none;" onchange="importarCSV()">
        </label>
        <button class="sort-btn" onclick="invertirOrden()">‚ÜîÔ∏è Invertir Orden</button>
        <button class="delete-all-btn" onclick="borrarTodos()">üóëÔ∏è Borrar todos los registros</button>
    </div>

    <div class="charts-container-main">
        <div class="chart-container-bar">
            <canvas id="miGraficaAnual"></canvas>
        </div>
        <div class="chart-container-bar">
            <canvas id="miGraficaMensualResumen"></canvas>
        </div>
        <div class="chart-container-bar">
            <canvas id="miGraficaMultiMensual"></canvas>
        </div>
    </div>
    
    <div class="tables-charts-container-middle">
        <table id="tablaResumen">
            <thead>
                <tr>
                    <th>Categor√≠as</th>
                    <th onclick="toggleFiltro('mes', 'tablaResumen')">
                        <span id="resumenMes">Mes</span><span>&#9660;</span>
                        <div id="filtro-mes-resumen" class="filter-menu"></div>
                    </th>
                    <th>Total A√±o</th>
                    <th>Media mensual</th>
                </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
                <tr>
                    <td>Total</td>
                    <td id="resumenTotal"></td>
                    <td id="resumenTotalAnual"></td>
                    <td id="resumenMedia"></td>
                </tr>
            </tfoot>
        </table>

        <div class="charts-container-pie">
            <div class="chart-container-pie">
                <canvas id="miGraficaPastelIngresos"></canvas>
            </div>
            <div class="chart-container-pie">
                <canvas id="miGraficaPastelGastos"></canvas>
            </div>
        </div>
    </div>
    
    <div class="tables-container-bottom">
        <div class="table-scroll-container">
            <table id="tablaRegistros">
                <thead>
                    <tr>
                        <th>
                            <div class="th-container" onclick="toggleFiltro('fecha', 'tablaRegistros')">Fecha<span>&#9660;</span></div>
                            <div id="filtro-fecha" class="filter-menu"></div>
                        </th>
                        <th>
                            <div class="th-container" onclick="toggleFiltro('mes', 'tablaRegistros')">Mes<span>&#9660;</span></div>
                            <div id="filtro-mes" class="filter-menu"></div>
                        </th>
                        <th>
                            <div class="th-container" onclick="toggleFiltro('categoria', 'tablaRegistros')">Categor√≠a<span>&#9660;</span></div>
                            <div id="filtro-categoria" class="filter-menu"></div>
                        </th>
                        <th>
                            <div class="th-container">Descripci√≥n</div>
                        </th>
                        <th>
                            <div class="th-container" onclick="toggleFiltro('ingresos', 'tablaRegistros')">Ingresos<span>&#9660;</span></div>
                            <div id="filtro-ingresos" class="filter-menu"></div>
                        </th>
                        <th>
                            <div class="th-container" onclick="toggleFiltro('gastos', 'tablaRegistros')">Gastos<span>&#9660;</span></div>
                            <div id="filtro-gastos" class="filter-menu"></div>
                        </th>
                        <th>
                            <div class="th-container">Balance</div>
                        </th>
                        <th>
                            <div class="th-container">Acciones</div>
                        </th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <div class="total" id="totalGeneral"><span id="totalGeneralMonto">Total: $0</span></div>

    <script>
        const firebaseConfig = {
          apiKey: "TU_API_KEY",
          authDomain: "TU_AUTH_DOMAIN",
          projectId: "TU_PROJECT_ID",
          storageBucket: "TU_STORAGE_BUCKET",
          messagingSenderId: "TU_MESSAGING_SENDER_ID",
          appId: "TU_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const registrosRef = database.ref('registros');
        
        let registros = [];
        let registrosFiltrados = [];
        let miGraficaPastelIngresos;
        let miGraficaPastelGastos;
        let miGraficaAnual;
        let miGraficaMensualResumen;
        let miGraficaMultiMensual;
        let ordenAscendente = false;
        
        let mesSeleccionadoResumen = null;

        const mesesOrdenados = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        Chart.register(ChartDataLabels);

        function obtenerNombreMes(fechaStr) {
            const fecha = new Date(fechaStr);
            return mesesOrdenados[fecha.getMonth()];
        }

        function normalizar(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
        }
        
        registrosRef.on('value', (snapshot) => {
            const data = snapshot.val();
            registros = data ? Object.values(data) : [];
            registrosFiltrados = [...registros];
            actualizarTodo();
        });

        function guardarRegistros() {
            // Se usa una condici√≥n para evitar guardar un array vac√≠o
            if (registros.length > 0) {
                registrosRef.set(registros)
                    .then(() => console.log("Datos guardados en Firebase"))
                    .catch(error => console.error("Error al guardar en Firebase:", error));
            } else {
                 registrosRef.set(null) // Esto borra todos los registros si el array est√° vac√≠o.
                    .then(() => console.log("Todos los registros borrados en Firebase."))
                    .catch(error => console.error("Error al borrar en Firebase:", error));
            }
        }

        function agregarRegistro() {
            const descripcion = document.getElementById("descripcion").value;
            const categoria = document.getElementById("categoria").value;
            const ingresoMonto = document.getElementById("ingreso-monto").value;
            const gastoMonto = document.getElementById("gasto-monto").value;

            if (categoria === "") {
                alert("Por favor, selecciona una categor√≠a.");
                return;
            }

            let monto = 0;
            if (ingresoMonto) {
                monto = parseFloat(ingresoMonto);
            } else if (gastoMonto) {
                monto = -parseFloat(gastoMonto);
            }

            const fecha = new Date().toLocaleDateString();
            const mes = obtenerNombreMes(new Date().toDateString());

            if (descripcion && (ingresoMonto || gastoMonto)) {
                registros.push({ fecha, mes, descripcion, categoria, monto });
                guardarRegistros();
                document.getElementById("descripcion").value = "";
                document.getElementById("ingreso-monto").value = "";
                document.getElementById("gasto-monto").value = "";
                document.getElementById("categoria").value = "";
            } else {
                alert("Por favor, llena la descripci√≥n y un monto (ingreso o gasto).");
            }
        }

        function borrarRegistro(indice) {
            if (confirm("¬øEst√°s seguro de que quieres borrar este registro?")) {
                registros.splice(indice, 1);
                guardarRegistros();
            }
        }

        function borrarTodos() {
            if (confirm("¬øEst√°s seguro de que quieres borrar TODOS los registros? Esta acci√≥n es irreversible.")) {
                registros = [];
                guardarRegistros();
            }
        }

        function exportarCSV() {
            if (registros.length === 0) {
                alert("No hay registros para exportar.");
                return;
            }

            let csv = "Fecha,Mes,Categor√≠a,Descripci√≥n,Ingresos,Gastos,Balance\n";
            registros.forEach(r => {
                const monto = parseFloat(r.monto);
                const ingresos = monto >= 0 ? monto : 0;
                const gastos = monto < 0 ? Math.abs(monto) : 0;
                csv += `${r.fecha},${r.mes},"${r.categoria}",${ingresos.toFixed(2)},${gastos.toFixed(2)},${monto.toFixed(2)}\n`;
            });

            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "ingresos_gastos.csv";
            link.click();
        }

        function importarCSV() {
            const archivoInput = document.getElementById('import-csv');
            const archivo = archivoInput.files[0];

            if (!archivo) {
                alert("Por favor, selecciona un archivo CSV para importar.");
                return;
            }

            const lector = new FileReader();
            lector.onload = function(e) {
                const texto = e.target.result;
                const lineas = texto.trim().split('\n');
                const nuevosRegistros = [];

                if (lineas.length <= 1) {
                    alert("El archivo CSV est√° vac√≠o o solo contiene la cabecera.");
                    return;
                }
                
                const categoriasPredefinidas = Array.from(document.getElementById('categoria').options)
                                                .map(option => ({
                                                    original: option.value,
                                                    normalizada: normalizar(option.value)
                                                }));

                const encabezado = lineas[0].split(',').map(h => h.trim().toLowerCase());
                const columnaFecha = encabezado.indexOf('fecha');
                const columnaMes = encabezado.indexOf('mes');
                const columnaCategoria = encabezado.indexOf('categoria');
                const columnaDescripcion = encabezado.indexOf('descripcion');
                const columnaIngresos = encabezado.indexOf('ingresos');
                const columnaGastos = encabezado.indexOf('gastos');
                
                if (columnaFecha === -1 || columnaMes === -1 || columnaCategoria === -1 || columnaDescripcion === -1 || columnaIngresos === -1 || columnaGastos === -1) {
                    alert("El archivo CSV no tiene el formato correcto. Aseg√∫rate de que las columnas 'fecha', 'mes', 'categoria', 'descripcion', 'ingresos' y 'gastos' existan.");
                    return;
                }

                for (let i = 1; i < lineas.length; i++) {
                    const columnas = lineas[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    if (columnas.length >= Math.max(columnaFecha, columnaMes, columnaCategoria, columnaDescripcion, columnaIngresos, columnaGastos) + 1) {
                        
                        const ingresosStr = columnas[columnaIngresos].replace(/"/g, '').trim();
                        const gastosStr = columnas[columnaGastos].replace(/"/g, '').trim();

                        const ingresos = parseFloat(ingresosStr) || 0;
                        const gastos = parseFloat(gastosStr) || 0;
                        
                        const monto = ingresos > 0 ? ingresos : -gastos;
                        
                        const categoriaCSV = columnas[columnaCategoria].replace(/"/g, '').trim();
                        const categoriaNormalizada = normalizar(categoriaCSV);
                        
                        const categoriaEncontrada = categoriasPredefinidas.find(cat => cat.normalizada === categoriaNormalizada);

                        const nuevoRegistro = {
                            fecha: columnas[columnaFecha].trim(),
                            mes: columnas[columnaMes].trim(),
                            categoria: categoriaEncontrada ? categoriaEncontrada.original : categoriaCSV,
                            descripcion: columnas[columnaDescripcion].replace(/"/g, '').trim(),
                            monto: monto 
                        };
                        nuevosRegistros.push(nuevoRegistro);
                    }
                }

                if (nuevosRegistros.length > 0) {
                    registros = registros.concat(nuevosRegistros);
                    guardarRegistros();
                    alert(`¬°Se importaron ${nuevosRegistros.length} registros exitosamente!`);
                } else {
                    alert("No se encontraron registros v√°lidos para importar.");
                }
            };
            lector.readAsText(archivo);
        }

        let filtros = {
            fecha: 'Todos',
            mes: 'Todos',
            categoria: 'Todos',
            ingresos: 'Todos',
            gastos: 'Todos'
        };

        function toggleFiltro(tipo, tabla) {
            const menuId = (tabla === 'tablaResumen' && tipo === 'mes') ? 'filtro-mes-resumen' : `filtro-${tipo}`;
            document.querySelectorAll('.filter-menu').forEach(menu => {
                if (menu.id !== menuId) {
                    menu.classList.remove('active');
                }
            });
            const filtro = document.getElementById(menuId);
            filtro.classList.toggle('active');
            if (filtro.classList.contains('active')) {
                llenarFiltro(tipo, tabla);
            }
        }

        function llenarFiltro(tipo, tabla) {
            const menuId = (tabla === 'tablaResumen' && tipo === 'mes') ? 'filtro-mes-resumen' : `filtro-${tipo}`;
            const filtro = document.getElementById(menuId);
            filtro.innerHTML = '';
            let opciones = [];

            if (tipo === 'fecha') {
                opciones = [...new Set(registros.map(r => r.fecha))];
            } else if (tipo === 'mes') {
                opciones = [...new Set(registros.map(r => r.mes))];
            } else if (tipo === 'categoria') {
                opciones = [...new Set(registros.map(r => r.categoria))];
            } else if (tipo === 'ingresos') {
                opciones = ['Ingresos'];
            } else if (tipo === 'gastos') {
                opciones = ['Gastos'];
            }

            opciones.sort();
            
            if (tabla === 'tablaResumen' && tipo === 'mes') {
                opciones.unshift('Seleccionar mes');
            } else {
                opciones.unshift('Todos');
            }

            opciones.forEach(opcion => {
                const label = document.createElement('label');
                label.innerText = opcion;
                label.onclick = () => {
                    aplicarFiltro(tipo, opcion, tabla);
                };
                filtro.appendChild(label);
            });
        }

        function aplicarFiltro(tipo, valor, tabla) {
            if (tabla === 'tablaResumen' && tipo === 'mes') {
                if (valor === 'Seleccionar mes') {
                    mesSeleccionadoResumen = null;
                } else {
                    mesSeleccionadoResumen = valor;
                }
            } else {
                filtros[tipo] = valor;
            }

            if (tabla === 'tablaRegistros') {
                registrosFiltrados = registros.filter(r => {
                    const cumpleFecha = filtros.fecha === 'Todos' || r.fecha === filtros.fecha;
                    const cumpleMes = filtros.mes === 'Todos' || r.mes === filtros.mes;
                    const cumpleCategoria = filtros.categoria === 'Todos' || r.categoria === filtros.categoria;
                    const cumpleIngresos = filtros.ingresos === 'Todos' || parseFloat(r.monto) >= 0;
                    const cumpleGastos = filtros.gastos === 'Todos' || parseFloat(r.monto) < 0;
                    
                    return cumpleFecha && cumpleMes && cumpleCategoria && cumpleIngresos && cumpleGastos;
                });
            }
            
            actualizarTodo();
            toggleFiltro(tipo, tabla);
        }

        function invertirOrden() {
            ordenAscendente = !ordenAscendente;
            actualizarTabla();
        }

        function aplicarFiltrosGuardados() {
            registrosFiltrados = registros.filter(r => {
                const cumpleFecha = filtros.fecha === 'Todos' || r.fecha === filtros.fecha;
                const cumpleMes = filtros.mes === 'Todos' || r.mes === filtros.mes;
                const cumpleCategoria = filtros.categoria === 'Todos' || r.categoria === filtros.categoria;
                const cumpleIngresos = filtros.ingresos === 'Todos' || parseFloat(r.monto) >= 0;
                const cumpleGastos = filtros.gastos === 'Todos' || parseFloat(r.monto) < 0;
                
                return cumpleFecha && cumpleMes && cumpleCategoria && cumpleIngresos && cumpleGastos;
            });
        }

        function actualizarTodo() {
            aplicarFiltrosGuardados();
            actualizarTabla();
            actualizarGraficaAnual();
            actualizarGraficaMensualResumen();
            actualizarGraficaMultiMensual();
            actualizarGraficaPastelIngresos();
            actualizarGraficaPastelGastos();
            actualizarTablaResumen();
        }
        
        function actualizarGraficaAnual() {
            if (miGraficaAnual) { miGraficaAnual.destroy(); }
            let totalIngresosAnual = 0;
            let totalGastosAnual = 0;
            registros.forEach(registro => {
                const monto = parseFloat(registro.monto);
                if (monto >= 0) { totalIngresosAnual += monto; } else { totalGastosAnual += Math.abs(monto); }
            });
            const data = { labels: ["Total Ingresos", "Total Gastos"], datasets: [{ label: 'Totales Anuales', data: [totalIngresosAnual, totalGastosAnual], backgroundColor: ['#4CAF50', '#F44336'], borderWidth: 1 }] };
            const config = {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Resumen Anual',
                            font: { size: 16 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: $${context.raw.toFixed(2)}`;
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            color: 'black',
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: function(value) {
                                return `$${value.toFixed(2)}`;
                            },
                            anchor: 'end',
                            align: 'top',
                            offset: 5
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Tipo de Movimiento'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Monto ($)'
                            },
                            beginAtZero: true
                        }
                    }
                },
                plugins: [ChartDataLabels]
            };
            const ctx = document.getElementById('miGraficaAnual').getContext('2d');
            miGraficaAnual = new Chart(ctx, config);
        }

        function actualizarGraficaMensualResumen() {
            if (miGraficaMensualResumen) { miGraficaMensualResumen.destroy(); }
            if (!mesSeleccionadoResumen) { document.getElementById('miGraficaMensualResumen').style.display = 'none'; return; } else { document.getElementById('miGraficaMensualResumen').style.display = 'block'; }
            let totalIngresosMes = 0;
            let totalGastosMes = 0;
            registros.forEach(registro => {
                const monto = parseFloat(registro.monto);
                if (registro.mes === mesSeleccionadoResumen) {
                    if (monto >= 0) { totalIngresosMes += monto; } else { totalGastosMes += Math.abs(monto); }
                }
            });
            const data = { labels: ["Total Ingresos", "Total Gastos"], datasets: [{ label: 'Totales Mensuales', data: [totalIngresosMes, totalGastosMes], backgroundColor: ['#4CAF50', '#F44336'], borderWidth: 1 }] };
            const config = {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: `Resumen Mensual - ${mesSeleccionadoResumen}`,
                            font: { size: 16 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: $${context.raw.toFixed(2)}`;
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            color: 'black',
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: function(value) {
                                return `$${value.toFixed(2)}`;
                            },
                            anchor: 'end',
                            align: 'top',
                            offset: 5
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Tipo de Movimiento'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Monto ($)'
                            },
                            beginAtZero: true
                        }
                    }
                },
                plugins: [ChartDataLabels]
            };
            const ctx = document.getElementById('miGraficaMensualResumen').getContext('2d');
            miGraficaMensualResumen = new Chart(ctx, config);
        }

        function actualizarGraficaMultiMensual() {
            if (miGraficaMultiMensual) { miGraficaMultiMensual.destroy(); }
            
            const mesesCompletos = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            
            const mesesConDatos = [...new Set(registros.map(r => r.mes))].sort((a, b) => mesesCompletos.indexOf(a) - mesesCompletos.indexOf(b));

            const mesesAbreviados = mesesConDatos.map(mes => mes.substring(0, 3).toUpperCase());

            const ingresosPorMes = {};
            const gastosPorMes = {};
            mesesConDatos.forEach(mes => { ingresosPorMes[mes] = 0; gastosPorMes[mes] = 0; });
            
            registros.forEach(registro => {
                if (parseFloat(registro.monto) >= 0) { 
                    ingresosPorMes[registro.mes] += parseFloat(registro.monto); 
                } else { 
                    gastosPorMes[registro.mes] += Math.abs(parseFloat(registro.monto)); 
                }
            });
            
            const data = { 
                labels: mesesAbreviados,
                datasets: [
                    { label: 'Total Ingresos', data: Object.values(ingresosPorMes), backgroundColor: '#4CAF50', borderWidth: 1 }, 
                    { label: 'Total Gastos', data: Object.values(gastosPorMes), backgroundColor: '#F44336', borderWidth: 1 }
                ] 
            };
            
            const config = { 
                type: 'bar', 
                data: data, 
                options: { 
                    responsive: true, 
                    plugins: { 
                        title: { display: true, text: 'Evoluci√≥n de Ingresos y Gastos por Mes', font: { size: 16 } }, 
                        tooltip: { 
                            callbacks: { 
                                label: function(context) { 
                                    return `${context.dataset.label}: $${context.raw.toFixed(1)}`; 
                                } 
                            } 
                        }, 
                        datalabels: { display: false } 
                    }, 
                    scales: { 
                        x: { 
                            title: { display: true, text: 'Mes' }, 
                            stacked: false 
                        }, 
                        y: { 
                            title: { display: true, text: 'Monto ($)' }, 
                            beginAtZero: true 
                        } 
                    } 
                } 
            };
            const ctx = document.getElementById('miGraficaMultiMensual').getContext('2d');
            miGraficaMultiMensual = new Chart(ctx, config);
        }

        function actualizarGraficaPastelIngresos() {
            if (!mesSeleccionadoResumen) {
                if (miGraficaPastelIngresos) { miGraficaPastelIngresos.destroy(); miGraficaPastelIngresos = null; }
                document.getElementById('miGraficaPastelIngresos').style.display = 'none';
                return;
            } else {
                document.getElementById('miGraficaPastelIngresos').style.display = 'block';
            }
            const ingresosDelMes = registros.filter(r => parseFloat(r.monto) >= 0 && r.mes === mesSeleccionadoResumen);
            const ingresosPorCategoria = {};
            ingresosDelMes.forEach(ingreso => {
                const categoriaNormalizada = normalizar(ingreso.categoria);
                if (ingresosPorCategoria[categoriaNormalizada]) { ingresosPorCategoria[categoriaNormalizada] += parseFloat(ingreso.monto); } else { ingresosPorCategoria[categoriaNormalizada] = parseFloat(ingreso.monto); }
            });
            const etiquetas = Object.keys(ingresosPorCategoria);
            const datos = Object.values(ingresosPorCategoria);
            const total = datos.reduce((acc, curr) => acc + curr, 0);
            const backgroundColors = [ '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#FF5722', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#FF5722' ];
            const data = { labels: etiquetas, datasets: [{ data: datos, backgroundColor: backgroundColors.slice(0, etiquetas.length), hoverOffset: 4 }] };
            const config = { type: 'pie', data: data, plugins: [ChartDataLabels], options: { responsive: true, plugins: { datalabels: { formatter: (value, context) => { const total = context.dataset.data.reduce((sum, current) => sum + current, 0); const percentage = (value / total * 100).toFixed(1) + '%'; return percentage; }, color: '#fff', font: { weight: 'bold' } }, title: { display: true, text: `Ingresos - ${mesSeleccionadoResumen}`, font: { size: 16 } }, tooltip: { enabled: true, callbacks: { label: function(context) { const label = context.label || ''; const value = context.raw; const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0; return `${label}: $${value.toFixed(1)} (${percentage}%)`; } } } } } };
            if (miGraficaPastelIngresos) { miGraficaPastelIngresos.destroy(); }
            const ctx = document.getElementById('miGraficaPastelIngresos').getContext('2d');
            miGraficaPastelIngresos = new Chart(ctx, config);
        }

        function actualizarGraficaPastelGastos() {
            if (!mesSeleccionadoResumen) {
                if (miGraficaPastelGastos) { miGraficaPastelGastos.destroy(); miGraficaPastelGastos = null; }
                document.getElementById('miGraficaPastelGastos').style.display = 'none';
                return;
            } else {
                document.getElementById('miGraficaPastelGastos').style.display = 'block';
            }
            const gastosDelMes = registros.filter(r => parseFloat(r.monto) < 0 && r.mes === mesSeleccionadoResumen);
            const gastosPorCategoria = {};
            gastosDelMes.forEach(gasto => {
                const categoriaNormalizada = normalizar(gasto.categoria);
                if (gastosPorCategoria[categoriaNormalizada]) { gastosPorCategoria[categoriaNormalizada] += Math.abs(parseFloat(gasto.monto)); } else { gastosPorCategoria[categoriaNormalizada] = Math.abs(parseFloat(gasto.monto)); }
            });
            const etiquetas = Object.keys(gastosPorCategoria);
            const datos = Object.values(gastosPorCategoria);
            const total = datos.reduce((acc, curr) => acc + curr, 0);
            const backgroundColors = [ '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED', '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED' ];
            const data = { labels: etiquetas, datasets: [{ data: datos, backgroundColor: backgroundColors.slice(0, etiquetas.length), hoverOffset: 4 }] };
            const config = { type: 'pie', data: data, plugins: [ChartDataLabels], options: { responsive: true, plugins: { datalabels: { formatter: (value, context) => { const total = context.dataset.data.reduce((sum, current) => sum + current, 0); const percentage = (value / total * 100).toFixed(1) + '%'; return percentage; }, color: '#fff', font: { weight: 'bold' } }, title: { display: true, text: `Gastos - ${mesSeleccionadoResumen}`, font: { size: 16 } }, tooltip: { enabled: true, callbacks: { label: function(context) { const label = context.label || ''; const value = context.raw; const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0; return `${label}: $${value.toFixed(1)} (${percentage}%)`; } } } } } };
            if (miGraficaPastelGastos) { miGraficaPastelGastos.destroy(); }
            const ctx = document.getElementById('miGraficaPastelGastos').getContext('2d');
            miGraficaPastelGastos = new Chart(ctx, config);
        }

        function actualizarTabla() {
            const tabla = document.querySelector("#tablaRegistros tbody");
            tabla.innerHTML = "";
            let totalAcumulado = 0;
            let listaParaMostrar = [...registrosFiltrados];
            if (!ordenAscendente) { listaParaMostrar.reverse(); }
            listaParaMostrar.forEach(registro => {
                const monto = parseFloat(registro.monto);
                const ingresos = monto >= 0 ? '$' + monto.toFixed(2) : '';
                const gastos = monto < 0 ? '$' + Math.abs(monto).toFixed(2) : '';
                const balance = '$' + monto.toFixed(2);
                const originalIndex = registros.findIndex(r => r.fecha === registro.fecha && r.descripcion === registro.descripcion && r.monto === registro.monto);
                let fila = `<tr><td>${registro.fecha}</td><td>${registro.mes}</td><td>${registro.categoria}</td><td>${registro.descripcion}</td><td>${ingresos}</td><td>${gastos}</td><td>${balance}</td><td><button class="delete-btn" onclick="borrarRegistro('${originalIndex}')">Borrar</button></td></tr>`;
                tabla.innerHTML += fila;
            });
            registros.forEach(registro => { totalAcumulado += parseFloat(registro.monto); });
            const totalGeneralElemento = document.getElementById("totalGeneralMonto");
            totalGeneralElemento.innerText = "Total: $" + totalAcumulado.toFixed(2);
            totalGeneralElemento.classList.remove('total-ingreso', 'total-gasto');
            if (totalAcumulado > 0) { totalGeneralElemento.classList.add('total-ingreso'); } else if (totalAcumulado < 0) { totalGeneralElemento.classList.add('total-gasto'); }
        }

        function actualizarTablaResumen() {
            const tabla = document.querySelector("#tablaResumen tbody");
            tabla.innerHTML = "";
            let totalGeneralMes = 0;
            let totalGeneralAnual = 0;
            let totalGeneralMedia = 0;
            const mesesConRegistros = new Set(registros.map(r => r.mes));
            const numeroDeMesesActual = mesesConRegistros.size > 0 ? mesesConRegistros.size : new Date().getMonth() + 1;
            const resumenCategoriasMes = {};
            const resumenCategoriasAnual = {};
            const categoriasOrdenadas = ["N√≥mina", "Extras", "Otros ingresos", "Inversi√≥n N√≥mina", "Gym/Salud", "Educaci√≥n", "Servicios/Renta", "Comida", "Transporte", "Gasto personal", "Streaming", "Salidas/viajes", "Impuestos"];
            if (mesSeleccionadoResumen) {
                document.getElementById("resumenMes").innerText = mesSeleccionadoResumen;
                const registrosMesSeleccionado = registros.filter(r => r.mes === mesSeleccionadoResumen);
                categoriasOrdenadas.forEach(categoria => { resumenCategoriasMes[normalizar(categoria)] = 0; });
                registrosMesSeleccionado.forEach(registro => { const categoriaNormalizada = normalizar(registro.categoria); resumenCategoriasMes[categoriaNormalizada] += parseFloat(registro.monto); });
            } else {
                document.getElementById("resumenMes").innerText = "Mes";
            }
            categoriasOrdenadas.forEach(categoria => { resumenCategoriasAnual[normalizar(categoria)] = 0; });
            registros.forEach(registro => { const categoriaNormalizada = normalizar(registro.categoria); resumenCategoriasAnual[categoriaNormalizada] += parseFloat(registro.monto); });
            const maxIngresoMes = mesSeleccionadoResumen ? Math.max(...Object.values(resumenCategoriasMes).filter(m => m > 0), 0) : 0;
            const maxGastoMes = mesSeleccionadoResumen ? Math.abs(Math.min(...Object.values(resumenCategoriasMes).filter(m => m < 0), 0)) : 0;
            const maxIngresoAnual = Math.max(...Object.values(resumenCategoriasAnual).filter(m => m > 0), 0);
            const maxGastoAnual = Math.abs(Math.min(...Object.values(resumenCategoriasAnual).filter(m => m < 0), 0));
            const resumenMedias = {};
            categoriasOrdenadas.forEach(categoria => { const categoriaNormalizada = normalizar(categoria); resumenMedias[categoriaNormalizada] = numeroDeMesesActual > 0 ? resumenCategoriasAnual[categoriaNormalizada] / numeroDeMesesActual : 0; });
            const maxIngresoMedia = Math.max(...Object.values(resumenMedias).filter(m => m > 0), 0);
            const maxGastoMedia = Math.abs(Math.min(...Object.values(resumenMedias).filter(m => m < 0), 0));
            categoriasOrdenadas.forEach(categoria => {
                const categoriaNormalizada = normalizar(categoria);
                const montoMes = mesSeleccionadoResumen ? resumenCategoriasMes[categoriaNormalizada] : 0;
                const montoAnual = resumenCategoriasAnual[categoriaNormalizada];
                const montoMedia = resumenMedias[categoriaNormalizada];
                let porcentajeMes = 0;
                let claseCeldaMes = 'money-cell';
                if (montoMes > 0) {
                    if (maxIngresoMes > 0) { porcentajeMes = (montoMes / maxIngresoMes) * 100; }
                    claseCeldaMes += ' ingreso';
                } else if (montoMes < 0) {
                    if (maxGastoMes > 0) { porcentajeMes = (Math.abs(montoMes) / maxGastoMes) * 100; }
                    claseCeldaMes += ' gasto';
                }
                let porcentajeAnual = 0;
                let claseCeldaAnual = 'money-cell';
                if (montoAnual > 0) {
                    if (maxIngresoAnual > 0) { porcentajeAnual = (montoAnual / maxIngresoAnual) * 100; }
                    claseCeldaAnual += ' ingreso';
                } else if (montoAnual < 0) {
                    if (maxGastoAnual > 0) { porcentajeAnual = (Math.abs(montoAnual) / maxGastoAnual) * 100; }
                    claseCeldaAnual += ' gasto';
                }
                let porcentajeMedia = 0;
                let claseCeldaMedia = 'money-cell';
                if (montoMedia > 0) {
                    if (maxIngresoMedia > 0) { porcentajeMedia = (montoMedia / maxIngresoMedia) * 100; }
                    claseCeldaMedia += ' ingreso';
                } else if (montoMedia < 0) {
                    if (maxGastoMedia > 0) { porcentajeMedia = (Math.abs(montoMedia) / maxGastoMedia) * 100; }
                    claseCeldaMedia += ' gasto';
                }
                const fila = document.createElement("tr");
                const celdaMontoMesHtml = `<td class="${claseCeldaMes}" style="background-size: ${porcentajeMes}% 100%;"><span>$${montoMes.toFixed(2)}</span></td>`;
                const celdaMontoAnualHtml = `<td class="${claseCeldaAnual}" style="background-size: ${porcentajeAnual}% 100%;"><span>$${montoAnual.toFixed(2)}</span></td>`;
                const celdaMontoMediaHtml = `<td class="${claseCeldaMedia}" style="background-size: ${porcentajeMedia}% 100%;"><span>$${montoMedia.toFixed(2)}</span></td>`;
                fila.innerHTML = `<td>${categoria}</td>${celdaMontoMesHtml}${celdaMontoAnualHtml}${celdaMontoMediaHtml}`;
                tabla.appendChild(fila);
                totalGeneralMes += montoMes;
                totalGeneralAnual += montoAnual;
            });
            totalGeneralMedia = numeroDeMesesActual > 0 ? totalGeneralAnual / numeroDeMesesActual : 0;
            const resumenTotalElementoMes = document.getElementById("resumenTotal");
            resumenTotalElementoMes.innerText = "$" + totalGeneralMes.toFixed(2);
            resumenTotalElementoMes.classList.remove('total-ingreso', 'total-gasto');
            if (totalGeneralMes > 0) { resumenTotalElementoMes.classList.add('total-ingreso'); } else if (totalGeneralMes < 0) { resumenTotalElementoMes.classList.add('total-gasto'); }
            const resumenTotalAnualElemento = document.getElementById("resumenTotalAnual");
            resumenTotalAnualElemento.innerText = "$" + totalGeneralAnual.toFixed(2);
            resumenTotalAnualElemento.classList.remove('total-ingreso', 'total-gasto');
            if (totalGeneralAnual > 0) { resumenTotalAnualElemento.classList.add('total-ingreso'); } else if (totalGeneralAnual < 0) { resumenTotalAnualElemento.classList.add('total-gasto'); }
            const resumenMediaElemento = document.getElementById("resumenMedia");
            resumenMediaElemento.innerText = "$" + totalGeneralMedia.toFixed(2);
            resumenMediaElemento.classList.remove('total-ingreso', 'total-gasto');
            if (totalGeneralMedia > 0) { resumenMediaElemento.classList.add('total-ingreso'); } else if (totalGeneralMedia < 0) { resumenMediaElemento.classList.add('total-gasto'); }
        }
    </script>
</body>
</html>